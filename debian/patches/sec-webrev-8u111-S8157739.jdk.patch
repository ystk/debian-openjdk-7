# HG changeset patch
# User hb
# Date 1468338405 -3600
#      Tue Jul 12 16:46:45 2016 +0100
# Node ID 588df0398c57435632a737bd64ab75f0d3885b54
# Parent  49681546459cb98374c07a465d09b3870e9fbfbf
8157739: Classloader Consistency Checking
Reviewed-by: ahgross, akulyakh, dfuchs, jwilhelm, skoivu

---
 openjdk/jdk/src/share/classes/com/sun/jmx/remote/util/ClassLoaderWithRepository.java |   12 +++++++++-
 1 file changed, 11 insertions(+), 1 deletion(-)

--- openjdk/jdk/src/share/classes/com/sun/jmx/remote/util/ClassLoaderWithRepository.java.orig
+++ openjdk/jdk/src/share/classes/com/sun/jmx/remote/util/ClassLoaderWithRepository.java
@@ -39,8 +39,9 @@ public class ClassLoaderWithRepository e
    }
 
     protected Class<?> findClass(String name) throws ClassNotFoundException {
+        Class<?> cls;
         try {
-            return repository.loadClass(name);
+            cls = repository.loadClass(name);
         } catch (ClassNotFoundException cne) {
             if (cl2 != null) {
                 return cl2.loadClass(name);
@@ -48,6 +49,15 @@ public class ClassLoaderWithRepository e
                 throw cne;
             }
         }
+
+        if(!cls.getName().equals(name)){
+            if (cl2 != null) {
+                return cl2.loadClass(name);
+            } else {
+                throw new ClassNotFoundException(name);
+            }
+        }
+        return cls;
     }
 
     private ClassLoaderRepository repository;
